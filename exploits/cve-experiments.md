## CVE Experiments
0. build kernel or use provided [bzImage](./bzImage)
   - kernel version: v5.10
   - apply objtool.patch
   - .config: allow unpriviledge bpf
1. Revert the affected modules to a vulnerable version
2. Launch exploit using a malicious eBPF program
3. Use ePass to avoid the exploit


**Sample result table:**

| Type                                              | CVE ID                          |
|---------------------------------------------------|---------------------------------|
| Improper validation                               | 2022-23222                      |
| Uninitialized pointers (nullptr) or memory access | 2022-3606, 2022-2785, 2022-0433 |
| ...                                               | ...                             |




### CVE summary
([google sheet](https://docs.google.com/spreadsheets/d/1jbsuB5wvWioRZXdvzSYrqkRWmLLXahdkUuYN3brDYiI/edit?usp=sharing))

#### CVE-2022-23222 (arbitrary pointer read/write)
([CVE-2023-3490](https://nvd.nist.gov/vuln/detail/CVE-2023-3490) has the same root cause, [exploit](https://github.com/advisories/GHSA-fx9p-2h37-fpg7) available)

- [Exploit Codebase](https://github.com/PenteraIO/CVE-2022-23222-POC)
- [Exploit explain](https://www.openwall.com/lists/oss-security/2022/01/18/2)
  1. Among all these *_OR_NULL types, we choose PTR_TO_MEM_OR_NULL
     which can be created by BPF_FUNC_ringbuf_reserve. First, we pass 0xffff........ffff to BPF_FUNC_ringbuf_reserve to get a
     NULL pointer r0, and copy r0 to r1. Then add r1 by 1, and do
     NULL check on r0. At this point, the verifier will believe that
     both r0 and r1 are zero.
  2. ALU sanitation is hardened after commit
     "bpf: Fix leakage of uninitialized bpf stack under speculation". To bypass alu sanitation, we use helper func bpf_skb_load_bytes_* to get partial/full overwrite the pointer on stack to obtain pointer address leakage and arbitrary address read/write.
  3. We spawn many child processes, and use arbitrary address read to find the address of task_struct and cred around the the address of the array map we created. After zeroing out the uid/gid/... , full root privileges obtained.
- Workaround: add boundary check to every pointer

